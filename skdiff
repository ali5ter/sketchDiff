#!/usr/bin/env bash
# @file skdiff.sh
# Show artboard changes between two versions of the same sketch file
# @author Alister Lewis-Bowen <alister@lewis-bowen.org>

[[ "$OSTYPE" == "darwin"* ]] || {
    echo "This will only run on macOS"
    exit 1
}

[[ -e /Applications/Sketch.app/Contents/Resources/sketchtool/bin/sketchtool ]] || {
    echo "Unable to find sketchtool under your Sketch application directory"
    exit 1
}
sketch=/Applications/Sketch.app/Contents/Resources/sketchtool/bin/sketchtool

type blink-diff &> /dev/null || {
    type npm &> /dev/null || {
        echo "To run image different detection you need to install blink-diff"
        echo "using the node package manage (npm). Please install npm."
        echo "Instructions at https://www.npmjs.com/get-npm"
        exit 1
    }
    echo "Installing blink-diff..."
    npm install -g blink-diff
}

SCRIPTPATH="$( cd "$(dirname "$0")" ; pwd -P )"
RESULTS_DIR='changes'
WORKING_DIR=~/.skdiff
FILE_A=''
FILE_B=''

[[ ! -L /usr/local/bin/skdiff ]] && ln -sf "$SCRIPTPATH/skdiff" /usr/local/bin

[[ "$0" = "$BASH_SOURCE" ]] && SOURCED='no' || SOURCED='yes';

_help() {
    echo "Show visual differences between two Sketch files."
    echo "Artbards added, deleted and visual changes are generated"
    echo "Usage: skdiff FILE_A.sketch FILE_B.sketch [options]"
    echo "Options:"
    echo "  -h, --help, help ... displays this help information"
    echo "  -o, --output ....... the directory for generated images"
    echo "                       Defaults to directory name: $RESULTS_DIR"
    return 0
}

err() { echo "$@" 1>&2; }

exportSketchArtboards () {

    local file="$1"
    local _file
    local dir="$WORKING_DIR/${file%.sketch}_artboards"
    [ -d "$dir" ] && rm -fR "$dir"

    "$sketch" export artboards "$file" --overwriting="YES" --include-symbols="NO" --output="$dir" > /dev/null

    while IFS= read -r _filename; do
        _file="${_filename#*/}" # strip containing dir
        _file="${_file// /_}"   # underscore all spaces
        _file="${_file//\//_}"  # underscore directory delimitor
        mv "$WORKING_DIR/$_filename" "$dir/$_file"
    done < <(find "$dir" -name "*.png" | sed -En "s#${WORKING_DIR}/##p")

    find "$dir" -type d -empty -delete

    return 0
}

diffSketchArtboards () {

    local dir_a="$1"
    local dir_b="$2"
    local odir="${3:-$RESULTS_DIR}"

    [ -d "$odir" ] && rm -fR "$odir"
    mkdir -p  "$odir/changed" "$odir/added" "$odir/deleted"

    while IFS= read -r _line; do
        _differ=$(echo "$_line" | sed -En 's#^Files (.*) and (.*) differ$#\1#p')
        _added=$(echo "$_line" | sed -En "s#^Only in ${dir_b}: (.*\.png)\$#\1#p")
        _removed=$(echo "$_line" | sed -En "s#^Only in ${dir_a}: (.*\.png)\$#\1#p")
        if [[ ! -z "$_differ" ]]; then
            _file=$(basename "$_differ")
            blink-diff --compose-ltr --output "$odir/changed/$_file" "$dir_a/$_file" "$dir_b/$_file" >/dev/null
            echo "<> $_file has changed"
        elif [[ ! -z "$_added" ]]; then
            cp "$dir_b/$_added" "$odir/added/$_added"
            echo "++ $_file added"
        elif [[ ! -z "$_removed" ]]; then
            cp "$dir_a/$_removed" "$odir/deleted/$_removed"
            echo "-- $_file removed"
        fi
    done < <(diff -rq "$dir_a" "$dir_b" | grep .png)

    return 0
}

genGitHook () {

    local git_root
    git_root=$(git rev-parse --show-toplevel)
    [[ -e "$git_root" ]] || {
        echo "You don't appear to be in a git repository"
        exit 1
    }
    _hookFile="$git_root/.git/hooks/post-commit"

    [[ -e "$_hookFile" ]] || {
        echo "\
#!/usr/bin/env
# @file post-commit githook
# Export artboards for any sketch files commited
# Generate directory of images showing differences between HEAD and last
# sketch file version
# (Generated by skdiff)
# @author Alister Lewis-Bowen <alister@lewis-bowen.org>

"
    }

    echo "\
set -e 

# Diagnostic info
#echo \"Running \$BASH_SOURCE\"
#echo \"PWD is \$PWD\"
#echo -e \"Git environment vars:\\n\$(set | egrep GIT)\"

source \"$SCRIPTPATH/../skdiff.sh\"

# Export sketch artboards for any Sketch files added/changed in this commit
thisCommitSha=\"\$(git log -1 | grep -e '^commit' | awk '{print \$2}')\"
thisCommitFiles=\"\$(git log -1 --name-status | grep .sketch | egrep -v '^D' | awk '{print \$2}')\"
for file in \$thisCommitFiles; do
    exportSketchArtboards \"\$file\"
    exportDir=\"\${file%.sketch}_artboards\"
    commitDir=\"\$(dirname \$file)/.\$thisCommitSha/\$file\"
    mkdir -p \"\$commitDir\"
    mv \"\$exportDir\"/* \"\$commitDir\"
done
"
    return 0
}

fileExists() {
    [[ ! -f "$1" ]] && {
        err "Unable to find file, $1"
        return 1
    }
    [[ "$1" != *.sketch ]] && {
        err "The file, $1, does not appear to be a sketch file"
        return 1
    }
    return 0
}

[[ "$SOURCED" == 'yes' ]] && return 0

[[ $# == 0 ]] && { _help; exit 1; }
while [[ $# -gt 0 ]]; do
    arg="$1"
    case $arg in
        -o|--output)    RESULTS_DIR=$2; shift;;
        -d)             set -x;;
        -h|--help|help) _help; exit 1;;
        *)  # positional args
            if [ -z "$FILE_A" ]; then FILE_A=$1;
            elif [ -z "$FILE_B" ]; then FILE_B=$1;fi
            ;;
    esac
    shift
done

fileExists "$FILE_A" && fileExists "$FILE_B" && {
    echo "Visual changes will be stored in directory, $RESULTS_DIR"
    exportSketchArtboards "$FILE_A"
    exportSketchArtboards "$FILE_B"
    diffSketchArtboards "$WORKING_DIR/${FILE_A%.sketch}_artboards" \
        "$WORKING_DIR/${FILE_B%.sketch}_artboards" \
        "$RESULTS_DIR"
}