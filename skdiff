#!/usr/bin/env bash
# @file skdiff.sh
# Show artboard changes between two versions of the same sketch file
# @author Alister Lewis-Bowen <alister@lewis-bowen.org>

[[ "$OSTYPE" == "darwin"* ]] || {
    echo "This will only run on macOS"
    exit 1
}

[[ -e /Applications/Sketch.app/Contents/Resources/sketchtool/bin/sketchtool ]] || {
    echo "Unable to find sketchtool under your Sketch application directory"
    exit 1
}
sketch=/Applications/Sketch.app/Contents/Resources/sketchtool/bin/sketchtool

type blink-diff &> /dev/null || {
    type npm &> /dev/null || {
        echo "To run image different detection you need to install blink-diff"
        echo "using the node package manage (npm). Please install npm."
        echo "Instructions at https://www.npmjs.com/get-npm"
        exit 1
    }
    echo "Installing blink-diff..."
    npm install -g blink-diff
}

exportSketchArtboards () {

    local file="$1"
    local _file
    local dir="${file%.sketch}_artboards"
    [ -d "$dir" ] && rm -fR "$dir"

    "$sketch" export artboards "$file" --overwriting="YES" --include-symbols="NO" --output="$dir" > /dev/null

    while IFS= read -r _filename; do
        _file="${_filename#*/}" # strip containing dir
        _file="${_file// /_}"   # underscore all spaces
        _file="${_file//\//_}"  # underscore directory delimitor
        mv "$_filename" "$dir/$_file"
    done < <(find "$dir" -name "*.png")

    find "$dir" -type d | grep -Ev "^$dir$" | xargs rm -fR

    return 0
}

diffSketchArtboards () {

    local dir_a="$1"
    local dir_b="$2"
    local odir="${3:-changes}"

    [ -d "$odir" ] && rm -fR "$odir"
    mkdir -p  "$odir/changed" "$odir/added" "$odir/deleted"

    while IFS= read -r _line; do
        _differ=$(echo "$_line" | sed -En 's#^Files (.*) and (.*) differ$#\1#p')
        _added=$(echo "$_line" | sed -En "s#^Only in ${dir_b}: (.*\.png)\$#\1#p")
        _removed=$(echo "$_line" | sed -En "s#^Only in ${dir_a}: (.*\.png)\$#\1#p")
        if [[ ! -z "$_differ" ]]; then
            _file=$(basename "$_differ")
            blink-diff --compose-ltr --output "$odir/changed/$_file" "$dir_a/$_file" "$dir_b/$_file" >/dev/null
            echo "<> $_file has changed"
        elif [[ ! -z "$_added" ]]; then
            cp "$dir_b/$_added" "$odir/added/$_added"
            echo "++ $_file added"
        elif [[ ! -z "$_removed" ]]; then
            cp "$dir_a/$_removed" "$odir/deleted/$_removed"
            echo "-- $_file removed"
        fi
    done < <(diff -rq "$dir_a" "$dir_b" | grep .png)

    return 0
}

genGitHook () {

    local git_root
    git_root=$(git rev-parse --show-toplevel)
    [[ -e "$git_root" ]] || {
        echo "You don't appear to be in a git repository"
        exit 1
    }
    _hookFile="$git_root/.git/hooks/post-commit"

    [[ -e "$_hookFile" ]] || {
        SCRIPTPATH="$( cd "$(dirname "$0")" ; pwd -P )"
        echo "\
#!/usr/bin/env
# @file post-commit githook
# Export artboards for any sketch files commited
# Generate directory of images showing differences between HEAD and last
# sketch file version
# (Generated by skdiff)
# @author Alister Lewis-Bowen <alister@lewis-bowen.org>

"
    }

    echo "\
set -e 

# Diagnostic info
#echo \"Running \$BASH_SOURCE\"
#echo \"PWD is \$PWD\"
#echo -e \"Git environment vars:\\n\$(set | egrep GIT)\"

source \"$SCRIPTPATH/../skdiff.sh\"

# Export sketch artboards for any Sketch files added/changed in this commit
thisCommitSha=\"\$(git log -1 | grep -e '^commit' | awk '{print \$2}')\"
thisCommitFiles=\"\$(git log -1 --name-status | grep .sketch | egrep -v '^D' | awk '{print \$2}')\"
for file in \$thisCommitFiles; do
    exportSketchArtboards \"\$file\"
    exportDir=\"\${file%.sketch}_artboards\"
    commitDir=\"\$(dirname \$file)/.\$thisCommitSha/\$file\"
    mkdir -p \"\$commitDir\"
    mv \"\$exportDir\"/* \"\$commitDir\"
done
"
    return 0
}

fileExists() {
    [[ ! -f "$1" ]] && {
        echo "Unable to find file, $1" 1>&2
        return 1
    }
    [[ "$1" != *.sketch ]] && {
        echo "The file, $1, doesn't appear to be a sketch file" 1>&2
        return 1
    }
    return 0
}

fileA="$1"
fileB="$2"
[[ "$3" == '-d' ]] && set -x
resultsDir='changes'

## TODO add help

fileExists "$fileA" && fileExists "$fileB" && {
    echo "Visual changes will be stored in directory, $resultsDir"
    exportSketchArtboards "$fileA"
    exportSketchArtboards "$fileB"
    diffSketchArtboards "${fileA%.sketch}_artboards" "${fileB%.sketch}_artboards" "$resultsDir"
}